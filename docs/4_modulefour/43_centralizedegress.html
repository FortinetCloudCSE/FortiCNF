<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.111.3"><meta name=generator content="Relearn 5.12.6+tip"><meta name=description content="FortiGate CNF Workshop"><meta name=author content="Hiruy Aberra"><title>Centralized Egress - FortiGate CNF Workshop</title><link href=../4_modulefour/43_centralizedegress/index.xml rel=alternate type=application/rss+xml title="Centralized Egress - FortiGate CNF Workshop"><link rel=icon href=https://www.fortinet.com/etc/designs/fortinet/favicon.ico type=image/x-icon><link href=../css/fontawesome-all.min.css?1684355376 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css?1684355376 rel=stylesheet></noscript><link href=../css/nucleus.css?1684355376 rel=stylesheet><link href=../css/auto-complete.css?1684355376 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css?1684355376 rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css?1684355376 rel=stylesheet><link href=../css/fonts.css?1684355376 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css?1684355376 rel=stylesheet></noscript><link href=../css/theme.css?1684355376 rel=stylesheet><link href=../css/theme-Fortinet.css?1684355376 rel=stylesheet id=variant-style><link href=../css/variant.css?1684355376 rel=stylesheet><link href=../css/print.css?1684355376 rel=stylesheet media=print><link href=../css/ie.css?1684355376 rel=stylesheet><script src=../js/url.js?1684355376></script>
<script src=../js/variant.js?1684355376></script>
<script>window.index_json_url="../index.json",window.index_js_url="../index.search.js";var root_url="../",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://fortinetcloudcse.github.io/FortiCNF/",window.variants&&variants.init(["Fortinet"])</script><style>@media screen and (min-width:1300px){#body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1300px;width:100%}}</style></head><body class="mobile-support html" data-url=../4_modulefour/43_centralizedegress.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div class=navigation><a class="nav nav-next topbar-link" href=../4_modulefour/44_centralizedeastwest.html title="Centralized East West (&#129106;)"><i class="fas fa-chevron-right fa-fw"></i></a></div><div class=navigation><a class="nav nav-prev topbar-link" href=../4_modulefour/42_distributedegress.html title="Distributed Egress (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../index.html><span itemprop=name>Secure AWS workloads with FortiGate CNF SaaS</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../4_modulefour.html><span itemprop=name>Workshop Test Traffic</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Centralized Egress</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class="chapter deprecated"><h1 id=centralized-egress>Centralized Egress</h1><p>For this traffic flow we will focus on the Shared Services, Workload, and Inspection VPCs. Centralized egress is commonly used when there is a strong desire to control egress traffic through a common set of NAT GWs in an egress or what we call an Inspection VPC. The benefit of this design is that you only need NAT GWs in the Inspection VPC (one per AZ) vs every VPC (one per AZ), which have an hourly cost. The caveat of this design is traffic will traverse additional AWS networking components for inspection (ie TGW, etc) that will have additional cost.</p><p><a href=#image-d126b9b17c117a4dbd991275a95fbe35 class=lightbox-link><img src=../images/image-cent-egress-diag1.png alt style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-d126b9b17c117a4dbd991275a95fbe35><img src=../images/image-cent-egress-diag1.png alt class=lightbox-image loading=lazy></a></p><p><strong>Step 1:</strong> An outbound connection starts with a private EC2 instance initiating a connection to a public resource. The first packet (ie TCP SYN) will be routed to the intrinsic router which will route traffic to the TGW attachment in the same AZ, as configured in the assigned VPC route table. The EC2 instance has a default route, received via DHCP, that points to the first host IP in the subnet which is the intrinsic router.</p><p><strong>Step 2:</strong> The traffic is received at the TGW ENI which then routes the traffic to the Inspection VPC TGW attachment, as configured in the associated Spoke VPC TGW route table.</p><p><strong>Step 3:</strong> The traffic is received at the TGW ENI in the Inspection VPC which then routes the traffic to the GWLBe endpoint in the same AZ, as configured in the associated VPC route table.</p><p><strong>Step 4:</strong> The traffic is received at the GWLBe endpoint which then routes the traffic to the associated GWLB ENI in the same AZ in the managed Fortinet AWS account/VPC. This is done behind the scene using AWS Private Link.</p><p><strong>Step 5:</strong> The traffic is received at the GWLB ENI and is then encapsulated in a GENEVE tunnel and routed to one of the instances in the FortiGate CNF auto scale group for traffic inspection. Post inspection, if the traffic is allowed, the instance will hairpin the traffic back to the same GWLB ENI over GENEVE. Then the GWLB ENI will hairpin the traffic back to the same GWLBe endpoint.</p><p><strong>Step 6:</strong> The GWLBe endpoint will then route the inspected traffic to the intrinsic router. The intrinsic router will route traffic directly to the NAT GW in the same AZ as specified in the VPC route table assigned to the subnet.</p><p><strong>Step 7:</strong> The traffic is received at the NAT GW ENI which then routes the traffic to the intrinsic router. The intrinsic router will route traffic directly to the IGW as specified in the VPC route table assigned to the subnet.</p><p><strong>Note:</strong> The NAT GW will source NAT the traffic to the private IP assigned to its ENI.</p><p><strong>Step 8:</strong> The destination will receive the traffic and respond. The return traffic will follow these steps in reverse.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>The IGW will source NAT the traffic to the public EIP assigned to the NAT GW ENI.</p></div></div><ul><li><ol><li>To test out this flow navigate to the <strong>AWS EC2 console and go to Instances > Instances</strong>. Then select either <strong>WrkInstance</strong> and click Connect > EC2 serial console. Copy the instance ID as this will be the username and click connect.</li></ol></li></ul><p><a href=#image-7557856eb2f6cf67fd47855ca68a4d1d class=lightbox-link><img src=../images/image-t5-6.png alt style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7557856eb2f6cf67fd47855ca68a4d1d><img src=../images/image-t5-6.png alt class=lightbox-image loading=lazy></a></p><p><a href=#image-7dbb5dac3336dfb3fdea0917e1170a75 class=lightbox-link><img src=../images/image-t5-7.png alt style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-7dbb5dac3336dfb3fdea0917e1170a75><img src=../images/image-t5-7.png alt class=lightbox-image loading=lazy></a></p><ul><li><ol start=2><li>Login to the instance with the instance ID as the username and <strong><code>FORTInet123!</code></strong> as the password. Then run the commands below to test traffic:</li></ol></li></ul><p><code>ping 8.8.8.8</code></p><p><code>curl http://ipinfo.io</code></p><p><code>curl https://ipinfo.io</code></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>You are now only allowing HTTPS outbound to one FQDN and ICMP to any public IP within the United States!</p></div></div><div class=expand><input type=checkbox id=expand-2 aria-controls=expandcontent-2>
<label class=expand-label for=expand-2><i class="fas fa-chevron-down"></i>
<i class="fas fa-chevron-right"></i>
Question 1: What happens if you try the same test from SSInstance1?</label><div id=expandcontent-2 class=expand-content><p>You should be able to access the IPinfo.io site over HTTPS and ping any public IP within the United States.</p></div></div><div class=expand><input type=checkbox id=expand-3 aria-controls=expandcontent-3>
<label class=expand-label for=expand-3><i class="fas fa-chevron-down"></i>
<i class="fas fa-chevron-right"></i>
Question 2: What address objects are allowing this communication to work even though the sdn-group = group3 for this instance?</label><div id=expandcontent-3 class=expand-content><p>AppPublicSubnet1 + AppPublicSubnet2. Remember that Dynamic, FQDN, and standard address objects still resolve to IPs. Since the Application-VPC and SharedServices-VPC share the same CIDR the data plane traffic will match on those Address objects.</p><p>A solution to this would be to use multiple CNF Instances in a region or expand on your tagging strategy to make the objects be more specific while avoiding using broad subnet CIDR values in the same L4 rule.</p></div></div><p><a href=#image-1741f5290cbdffbdc38b21ab8565ce0f class=lightbox-link><img src=../images/image-t5-8.png alt style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-1741f5290cbdffbdc38b21ab8565ce0f><img src=../images/image-t5-8.png alt class=lightbox-image loading=lazy></a></p><footer class=footline></footer></article></div></main></div><aside id=sidebar class="default-animation showVisitedLinks"><div id=header-wrapper class=default-animation><div id=header class=default-animation><a href=../ title="Fortinet Demos"><img style=vertical-align:middle src=../Fortinet-logo-rgb-white-red.svg height=70px></a></div><form action=../search.html method=get><div class="searchbox default-animation"><button type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div></form><script>var contentLangs=["en"]</script><script src=../js/auto-complete.js?1684355376 defer></script>
<script src=../js/lunr/lunr.min.js?1684355376 defer></script>
<script src=../js/lunr/lunr.stemmer.support.min.js?1684355376 defer></script>
<script src=../js/lunr/lunr.multi.min.js?1684355376 defer></script>
<script src=../js/lunr/lunr.en.min.js?1684355376 defer></script>
<script src=../js/search.js?1684355376 defer></script></div><div id=homelinks class=default-animation><ul><li><a class=padding href=../index.html><i class="fas fa-home"></i> Home</a></li></ul></div><div id=content-wrapper class=highlightable><ul class="topics enlarge morespace collapsible-menu"><li data-nav-id=/1_moduleone.html><a class=padding href=../1_moduleone.html>Introduction<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2_moduletwo.html><input type=checkbox id=section-6180d618e477c4171cc9d7ced5bb0928 aria-controls=subsections-6180d618e477c4171cc9d7ced5bb0928><label for=section-6180d618e477c4171cc9d7ced5bb0928><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Workshop Prerequisites</span></label><a class=padding href=../2_moduletwo.html>Workshop Prerequisites<i class="fas fa-check read-icon"></i></a><ul id=subsections-6180d618e477c4171cc9d7ced5bb0928 class="morespace collapsible-menu"><li data-nav-id=/2_moduletwo/21_logistics.html><a class=padding href=../2_moduletwo/21_logistics.html>Workshop Logistics<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2_moduletwo/22_awsnetworkingconcepts.html><a class=padding href=../2_moduletwo/22_awsnetworkingconcepts.html>AWS Networking Concepts<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2_moduletwo/23_awscommonarchitecturepatterns.html><a class=padding href=../2_moduletwo/23_awscommonarchitecturepatterns.html>AWS Common Architecture Patterns<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2_moduletwo/24_fortigatecnfterminology.html><a class=padding href=../2_moduletwo/24_fortigatecnfterminology.html>FortiGate CNF Terminology<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/3_modulethree.html><input type=checkbox id=section-787a272b0074b57237733dd429c6920c aria-controls=subsections-787a272b0074b57237733dd429c6920c><label for=section-787a272b0074b57237733dd429c6920c><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Workshop Hands On</span></label><a class=padding href=../3_modulethree.html>Workshop Hands On<i class="fas fa-check read-icon"></i></a><ul id=subsections-787a272b0074b57237733dd429c6920c class="morespace collapsible-menu"><li data-nav-id=/3_modulethree/31_task1.html><a class=padding href=../3_modulethree/31_task1.html>Task 1: Subscribe to FortiGate CNF in AWS Marketplace<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3_modulethree/32_task2.html><a class=padding href=../3_modulethree/32_task2.html>Task 2: Onboard an AWS account to FortiGate CNF<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3_modulethree/33_task3.html><a class=padding href=../3_modulethree/33_task3.html>Task 3: Deploying CNF Instances and GWLBe endpoints<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3_modulethree/34_task4.html><a class=padding href=../3_modulethree/34_task4.html>Task 4: Create a policy set and apply it to a FortiGate CNF Instance<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3_modulethree/35_task5.html><a class=padding href=../3_modulethree/35_task5.html>Task 5: Validate Resolution of Dynamic Address Objects<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/4_modulefour.html class=parent><input type=checkbox id=section-e0da539b16e47ab0661df6a76b214530 aria-controls=subsections-e0da539b16e47ab0661df6a76b214530 checked><label for=section-e0da539b16e47ab0661df6a76b214530><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Workshop Test Traffic</span></label><a class=padding href=../4_modulefour.html>Workshop Test Traffic<i class="fas fa-check read-icon"></i></a><ul id=subsections-e0da539b16e47ab0661df6a76b214530 class="morespace collapsible-menu"><li data-nav-id=/4_modulefour/41_distributedingress.html><a class=padding href=../4_modulefour/41_distributedingress.html>Distributed Ingress<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4_modulefour/42_distributedegress.html><a class=padding href=../4_modulefour/42_distributedegress.html>Distributed Egress<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4_modulefour/43_centralizedegress.html class=active><a class=padding href=../4_modulefour/43_centralizedegress.html>Centralized Egress<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4_modulefour/44_centralizedeastwest.html><a class=padding href=../4_modulefour/44_centralizedeastwest.html>Centralized East West<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/5_modulefive.html><input type=checkbox id=section-eedb4ce2417d1c035ec50daff6810936 aria-controls=subsections-eedb4ce2417d1c035ec50daff6810936><label for=section-eedb4ce2417d1c035ec50daff6810936><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Extra Credit</span></label><a class=padding href=../5_modulefive.html>Extra Credit<i class="fas fa-check read-icon"></i></a><ul id=subsections-eedb4ce2417d1c035ec50daff6810936 class="morespace collapsible-menu"><li data-nav-id=/5_modulefive/51_task1.html><a class=padding href=../5_modulefive/51_task1.html>Task 1: Deploying CNF Instances and GWLBe endpoints<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5_modulefive/52_task2.html><a class=padding href=../5_modulefive/52_task2.html>Task 2: FortiManager Integration<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5_modulefive/53_task3.html><a class=padding href=../5_modulefive/53_task3.html>Task 3: FortiAnalyzer Integration<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/6_modulesix.html><a class=padding href=../6_modulesix.html>Providing Feedback<i class="fas fa-check read-icon"></i></a></li></ul><div id=shortcuts><div class="nav-title padding">Helpful Resources</div><ul class=space><li><a class=padding href=https://fortinet.com/aws><i class='far fa-lightbulb'></i> Fortinet's AWS Microsite</a></li><li><a class=padding href="https://aws.amazon.com/marketplace/search/results?searchTerms=fortinet"><i class='fas fa-tools'></i> AWS MP Listings for Fortinet</a></li><li><a class=padding href=https://docs.fortinet.com/cloud-solutions/aws><i class='far fa-lightbulb'></i> Fortinet in AWS Docs</a></li><li><a class=padding href=https://docs.fortinet.com/product/fortigate-cnf><i class='fas fa-chalkboard-teacher'></i> FortiGate CNF Docs</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVisitedLinks showFooter"></div><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVisitedLinks showFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks showVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding select-container"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=select-clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding select-container"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=Fortinet value=Fortinet selected>Fortinet</option></select></div><div class=select-clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class="footerVisitedLinks showVisitedLinks"><button class=padding onclick=clearHistory()><i class="fas fa-history fa-fw"></i><span>&nbsp;</span>Clear History</button></li></ul></div><div id=footer class="footerFooter showFooter"><style>#footer{font-size:.8125rem;height:6.25rem;margin-left:auto;margin-right:auto;padding:2rem 1rem;text-align:center;min-width:14.375rem;max-width:18.75rem}#footer p{margin:0}</style><left><a href=https://www.fortinet.com/corporate/about-us/privacy target=_blank rel="noreferrer noopener">Privacy</a> | <a href=https://www.fortinet.com/corporate/about-us/legal target=_blank rel="noreferrer noopener">Site Terms</a> | <a href=https://www.fortinet.com/corporate/about-us/about-us target=_blank rel="noreferrer noopener">About Us</a></left></div></div></aside><script src=../js/clipboard.min.js?1684355376 defer></script>
<script src=../js/perfect-scrollbar.min.js?1684355376 defer></script>
<script src=../js/theme.js?1684355376 defer></script></body></html>